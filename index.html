<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Material Purchase Form</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for Inter font and general body */
        body {
            font-family: "Inter", sans-serif;
            background-color: #f0f2f5; /* Light gray background */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to start for better scrolling on smaller screens */
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }
        /* Ensure the main container is responsive and centered */
        .form-container {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            width: 100%;
            margin-top: 20px;
            margin-bottom: 20px;
        }
        .item-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .item-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
        }
        /* Styling for the tab buttons */
        .tab-button {
            padding: 10px 15px;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            background-color: #e2e8f0; /* bg-gray-200 */
            color: #4a5568; /* text-gray-700 */
            font-weight: 500;
            transition: background-color 0.3s ease;
            white-space: nowrap; /* Prevent wrapping */
        }
        .tab-button.active {
            background-color: #ffffff;
            color: #3182ce; /* text-blue-600 */
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
            z-index: 10;
        }
        .tab-buttons-container {
            overflow-x: auto; /* Allow horizontal scrolling for many tabs */
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
            scrollbar-width: none; /* Hide scrollbar for Firefox */
            -ms-overflow-style: none;  /* Hide scrollbar for IE and Edge */
        }
        .tab-buttons-container::-webkit-scrollbar {
            display: none; /* Hide scrollbar for Chrome, Safari, Opera */
        }
        /* Cover page styling */
        .cover-page-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: #f0f2f5;
            padding: 20px;
            box-sizing: border-box;
        }
        .cover-page-card {
            background-color: #ffffff;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 100%;
            text-align: center;
        }
        .cover-page-input {
            padding: 12px 15px;
            border: 1px solid #cbd5e0; /* border-gray-300 */
            border-radius: 8px;
            width: 100%;
            font-size: 1.1rem;
            margin-bottom: 20px;
            box-sizing: border-box;
        }
        .cover-page-button {
            background-color: #3b82f6; /* bg-blue-500 */
            color: white;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .cover-page-button:hover {
            background-color: #2563eb; /* bg-blue-600 */
        }
        /* Styling for LPO Dashboard */
        .lpo-dashboard-container {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            width: 100%;
            margin-top: 20px;
            margin-bottom: 20px;
        }
        .order-card {
            background-color: #f8fafc; /* bg-gray-50 */
            border: 1px solid #e2e8f0; /* border-gray-200 */
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <!-- Cover Page -->
    <div id="cover-page-container" class="cover-page-container hidden">
        <div class="cover-page-card">
            <h1 class="text-4xl font-bold text-gray-800 mb-6">Welcome!</h1>
            <p class="text-gray-600 text-lg mb-8">Please enter your name to proceed.</p>
            <input type="text" id="user-name-input" class="cover-page-input" placeholder="Your Name" required>
            <button id="proceed-button" class="cover-page-button">Proceed to Form</button>
        </div>
    </div>

    <!-- Main Form Container -->
    <div id="main-form-container" class="form-container hidden">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">Material Purchase Order</h1>

        <!-- Search Bar -->
        <div class="mb-6">
            <input type="text" id="search-bar" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="Search for materials...">
        </div>

        <!-- Tabs for Categories -->
        <div class="tab-buttons-container flex border-b border-gray-200 mb-6 -mx-3 px-3">
            <button class="tab-button active" data-category="All">All</button>
            <button class="tab-button" data-category="General Food">General Food</button>
            <button class="tab-button" data-category="Packing">Packing</button>
            <button class="tab-button" data-category="Dairy">Dairy</button>
            <button class="tab-button" data-category="Halal Meat">Halal Meat</button>
            <button class="tab-button" data-category="Hygiene">Hygiene</button>
            <button class="tab-button" data-category="LPO Dashboard">LPO Dashboard</button> <!-- New tab -->
        </div>

        <!-- Material Items List -->
        <div id="items-list" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
            <!-- Items will be rendered here by JavaScript -->
        </div>

        <!-- Order Summary Section -->
        <div id="order-summary-div" class="hidden bg-blue-50 border border-blue-200 p-4 rounded-lg mb-6">
            <h2 class="text-xl font-semibold text-blue-800 mb-3">Order Summary</h2>
            <ul id="summary-list" class="list-disc list-inside text-blue-700">
                <!-- Summary items will be added here -->
            </ul>
            <p id="no-items-selected-msg" class="text-blue-700 hidden">No items selected yet.</p>
        </div>

        <!-- Buttons -->
        <div class="flex justify-between">
            <button id="clear-button" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                Clear Order
            </button>
            <button id="submit-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg focus:outline-none focus:shadow-outline text-lg">
                Submit Order
            </button>
        </div>
    </div>

    <!-- LPO Dashboard Container (Initially Hidden) -->
    <div id="lpo-dashboard-container" class="lpo-dashboard-container hidden">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">LPO Generation Dashboard</h1>
        <p class="text-gray-600 mb-4">Review pending orders and generate Local Purchase Orders.</p>

        <div id="pending-orders-list" class="mt-6">
            <!-- Pending orders will be loaded here -->
            <p id="no-pending-orders" class="text-gray-500 italic hidden">No pending orders to process.</p>
        </div>
    </div>

    <script>
        // IMPORTANT: This URL has been updated to the one you provided.
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycby9ojEAAvdXEFxRJS1_2Fgqg2t3innz8qfsUKKR4aViD7WIcwcyeWiwhPKRXxm2AMfq/exec';

        // Material Items Data (UPDATED WITH UNITS)
        const items = [
            { id: 1, name: "Pizza box 9x9", category: "Packing", unit: "ctn" },
            { id: 2, name: "Ajinomoto", category: "General Food", unit: "ctn" },
            { id: 3, name: "Macaron Powder", category: "General Food", unit: "bags" },
            { id: 4, name: "Aluminum Foil", category: "Packing", unit: "ctn" },
            { id: 5, name: "Aluminum Tray 1x100 Regular size", category: "Packing", unit: "ctn" },
            { id: 6, name: "Aluminum Tray 1x50 Big size", category: "Packing", unit: "ctn" },
            { id: 7, name: "Apple Filling", category: "General Food", unit: "tin" },
            { id: 8, name: "Baking Powder", category: "General Food", unit: "ctn" },
            { id: 9, name: "Beef Burger", category: "Halal Meat", unit: "ctn" },
            { id: 10, name: "Beef Liver", category: "Halal Meat", unit: "ctn" },
            { id: 11, name: "Beef Tenderloin", category: "Halal Meat", unit: "ctn" },
            { id: 12, name: "Beef Topside Brazil", category: "Halal Meat", unit: "ctn" },
            { id: 13, name: "Black Garbage Bag", category: "Hygiene", unit: "ctn" },
            { id: 14, name: "Black Grains Bread", category: "General Food", unit: "bags" },
            { id: 15, name: "Black Olives slice", category: "General Food", unit: "ctn" },
            { id: 16, name: "Black Pepper powder 24x250grm", category: "General Food", unit: "ctn" },
            { id: 17, name: "Blue-Barry Filling", category: "General Food", unit: "tin" },
            { id: 18, name: "Broad Beans", category: "General Food", unit: "bags" },
            { id: 19, name: "Burghul Brown", category: "General Food", unit: "bags" },
            { id: 20, name: "Butter Block", category: "Dairy", unit: "ctn" },
            { id: 21, name: "Butter Paper", category: "Packing", unit: "ctn" },
            { id: 22, name: "Cake Box size 25", category: "Packing", unit: "pcs" },
            { id: 23, name: "Cake Box size 30", category: "Packing", unit: "pcs" },
            { id: 24, name: "Cake Box size 35", category: "Packing", unit: "pcs" },
            { id: 25, name: "Cake Marking", category: "Packing", unit: "pcs" },
            { id: 26, name: "Cardamom Powder 24x250", category: "General Food", unit: "ctn" },
            { id: 27, name: "Cashewnut", category: "General Food", unit: "bags" },
            { id: 28, name: "Chicken Breast", category: "Halal Meat", unit: "ctn" },
            { id: 29, name: "Chicken Burger", category: "Halal Meat", unit: "ctn" },
            { id: 30, name: "Chicken Fillet", category: "Halal Meat", unit: "ctn" },
            { id: 31, name: "Chicken Liver", category: "Halal Meat", unit: "ctn" },
            { id: 32, name: "Chicken Sausage", category: "Halal Meat", unit: "ctn" },
            { id: 33, name: "Chicken Shawarma", category: "Halal Meat", unit: "ctn" },
            { id: 34, name: "Chickpeas", category: "General Food", unit: "bags" },
            { id: 35, name: "Cinnamon Powder 24x250", category: "General Food", unit: "ctn" },
            { id: 36, name: "Clear Tap 48mmX36", category: "Packing", unit: "ctn" },
            { id: 37, name: "Cling Film 30cm", category: "Packing", unit: "ctn" },
            { id: 38, name: "Cling Film 45cm", category: "Packing", unit: "ctn" },
            { id: 39, name: "Clorix", category: "Hygiene", unit: "ctn" },
            { id: 40, name: "Coconut Powder", category: "General Food", unit: "bags" },
            { id: 41, name: "Coffee Cup", category: "Packing", unit: "ctn" },
            { id: 42, name: "Compound Dark Chocolate", category: "General Food", unit: "ctn" },
            { id: 43, name: "Coriander Powder 24x250", category: "General Food", unit: "ctn" },
            { id: 44, name: "Corn Flour", category: "General Food", unit: "bags" },
            { id: 45, name: "Cream Cake Mix Chocolate", category: "General Food", unit: "bags" },
            { id: 46, name: "Cream Cake Mix Vanilla", category: "General Food", unit: "bags" },
            { id: 47, name: "Cumin Powder 24x250", category: "General Food", unit: "ctn" },
            { id: 48, name: "Cup-Cake size 9.5", category: "Packing", unit: "ctn" },
            { id: 49, name: "Custard Powder", category: "General Food", unit: "ctn" },
            { id: 50, name: "Dark Chocolate Coins", category: "General Food", unit: "ctn" },
            { id: 51, name: "Dark Malts", category: "General Food", unit: "bags" },
            { id: 52, name: "Dates Syrup", category: "General Food", unit: "ctn" },
            { id: 53, name: "Detergent Powder", category: "Hygiene", unit: "bags" },
            { id: 54, name: "Digestive Biscuits", category: "General Food", unit: "ctn" },
            { id: 55, name: "Donut Box", category: "Packing", unit: "ctn" },
            { id: 56, name: "Egyptian Rice", category: "General Food", unit: "bags" },
            { id: 57, name: "Feta Cheese", category: "General Food", unit: "ctn" },
            { id: 58, name: "Foam Plate S1", category: "Packing", unit: "ctn" },
            { id: 59, name: "Foam Plate S2", category: "Packing", unit: "ctn" },
            { id: 60, name: "Foam Plate S3", category: "Packing", unit: "ctn" },
            { id: 61, name: "Foam Plate S4", category: "Packing", unit: "ctn" },
            { id: 62, name: "Fondant Sugar", category: "General Food", unit: "pkt" },
            { id: 63, name: "French Fries", category: "General Food", unit: "ctn" },
            { id: 64, name: "Fresh Cream", category: "Dairy", unit: "ctn" },
            { id: 65, name: "Frosting Sheets", category: "Packing", unit: "ctn" },
            { id: 66, name: "Fruits Cocktail", category: "General Food", unit: "ctn" },
            { id: 67, name: "Garlic Powder 24x250grm", category: "General Food", unit: "ctn" },
            { id: 68, name: "Ghee", category: "General Food", unit: "ctn" },
            { id: 69, name: "Ginger Powder 24x250grm", category: "General Food", unit: "ctn" },
            { id: 70, name: "Gloves Large", category: "Hygiene", unit: "ctn" },
            { id: 71, name: "Gloves Medium", category: "Hygiene", unit: "ctn" },
            { id: 72, name: "Gloves Xlarge", category: "Hygiene", unit: "ctn" },
            { id: 73, name: "Golden Twist Pin", category: "Packing", unit: "ctn" },
            { id: 74, name: "Grape Leaves", category: "General Food", unit: "ctn" },
            { id: 75, name: "Green Olives slice", category: "General Food", unit: "ctn" },
            { id: 76, name: "Hair Net Cap", category: "Hygiene", unit: "ctn" },
            { id: 77, name: "Hand Soap", category: "Hygiene", unit: "ctn" },
            { id: 78, name: "HD Carry Bag Large", category: "Packing", unit: "ctn" },
            { id: 79, name: "HD Carry Bag XL", category: "Packing", unit: "ctn" },
            { id: 80, name: "HD Carry Bag XXL", category: "Packing", unit: "ctn" },
            { id: 81, name: "Hot Pepper Paste", category: "General Food", unit: "ctn" },
            { id: 82, name: "Hot Sauce", category: "General Food", unit: "ctn" },
            { id: 83, name: "Kabab Powder", category: "General Food", unit: "bags" },
            { id: 84, name: "Kiri Cheese", category: "Dairy", unit: "ctn" },
            { id: 85, name: "Labna", category: "Dairy", unit: "ctn" },
            { id: 86, name: "Mutton Leg", category: "Halal Meat", unit: "kg" },
            { id: 87, name: "Maxi Roll", category: "Hygiene", unit: "ctn" },
            { id: 88, name: "Mayonnaise Gallon", category: "General Food", unit: "pkt" },
            { id: 89, name: "Mayonnaise Sachet", category: "General Food", unit: "ctn" },
            { id: 90, name: "Meats Masala 24x250", category: "General Food", unit: "ctn" },
            { id: 91, name: "Milk 1L", category: "Dairy", unit: "ctn" },
            { id: 92, name: "Milk Powder", category: "General Food", unit: "bags" },
            { id: 93, name: "Minced Beef", category: "Halal Meat", unit: "ctn" },
            { id: 94, name: "Mix Bahrain Masala 24x250", category: "General Food", unit: "ctn" },
            { id: 95, name: "Mixed Fruits Jam", category: "General Food", unit: "ctn" },
            { id: 96, name: "Mozzarella Cheese", category: "Dairy", unit: "ctn" },
            { id: 97, name: "Mushrooms", category: "General Food", unit: "ctn" },
            { id: 98, name: "Mutton Fat", category: "Halal Meat", unit: "kg" },
            { id: 99, name: "Nestle Coffee", category: "General Food", unit: "ctn" },
            { id: 100, name: "Nestle Cream", category: "General Food", unit: "ctn" },
            { id: 101, name: "Neutral Cold Glaze", category: "General Food", unit: "pkt" },
            { id: 102, name: "Olive Oil 4x4", category: "General Food", unit: "ctn" },
            { id: 103, name: "Orange Color", category: "General Food", unit: "ctn" },
            { id: 104, name: "Orange Flavor", category: "General Food", unit: "ctn" },
            { id: 105, name: "Oyster sauce", category: "General Food", unit: "ctn" },
            { id: 106, name: "Paper Bag size no1", category: "Packing", unit: "ctn" },
            { id: 107, name: "Paper Bag size no2", category: "Packing", unit: "ctn" },
            { id: 108, name: "Paper Bag size no3", category: "Packing", unit: "ctn" },
            { id: 109, name: "Pastry Margins", category: "General Food", unit: "ctn" },
            { id: 110, name: "Peaches Slice", category: "General Food", unit: "ctn" },
            { id: 111, name: "Peanuts", category: "General Food", unit: "kg" },
            { id: 112, name: "Pineapple Slice", category: "General Food", unit: "ctn" },
            { id: 113, name: "Pistachio Kernel", category: "General Food", unit: "kg" },
            { id: 114, name: "Pizza Paper Box big size", category: "Packing", unit: "ctn" },
            { id: 115, name: "Pizza Sauce", category: "General Food", unit: "ctn" },
            { id: 116, name: "Plastic Spoon", category: "General Food", unit: "ctn" },
            { id: 117, name: "Pts Box", category: "Packing", unit: "ctn" },
            { id: 118, name: "Raisins", category: "General Food", unit: "kg" },
            { id: 119, name: "Red Chili Powder 12x250", category: "General Food", unit: "ctn" },
            { id: 120, name: "Rhc2 Box", category: "Packing", unit: "ctn" },
            { id: 121, name: "Rhc5 Box", category: "Packing", unit: "ctn" },
            { id: 122, name: "Sandwich Box", category: "Packing", unit: "ctn" },
            { id: 123, name: "Semolina", category: "General Food", unit: "bags" },
            { id: 124, name: "Sesame Seed", category: "General Food", unit: "bags" },
            { id: 125, name: "Shortening", category: "General Food", unit: "ctn" },
            { id: 126, name: "Sodium Bicarbonate", category: "General Food", unit: "ctn" },
            { id: 127, name: "Soya Sauce", category: "General Food", unit: "ctn" },
            { id: 128, name: "Sponge Cake Mix Chocolate", category: "General Food", unit: "bags" },
            { id: 129, name: "Sponge Cake Mix Vanilla", category: "General Food", unit: "bags" },
            { id: 130, name: "Spring Roll Paper", category: "General Food", unit: "ctn" },
            { id: 131, name: "Sugar", category: "General Food", unit: "bags" },
            { id: 132, name: "Sumac Powder 24x250grm", category: "General Food", unit: "ctn" },
            { id: 133, name: "Sunflower Oil 6x1.8", category: "General Food", unit: "ctn" },
            { id: 134, name: "Tahina", category: "General Food", unit: "tin" },
            { id: 135, name: "Tea Powder", category: "General Food", unit: "bags" },
            { id: 136, name: "Tomato Ketchup Gallon", category: "General Food", unit: "ctn" },
            { id: 137, name: "Tomato Paste", category: "General Food", unit: "ctn" },
            { id: 138, name: "Tomatoes Ketchup Sachet", category: "General Food", unit: "ctn" },
            { id: 139, name: "Topping for Special Bread", category: "General Food", unit: "bags" },
            { id: 140, name: "Turmeric Powder", category: "General Food", unit: "ctn" },
            { id: 141, name: "Tutti frutti", category: "General Food", unit: "bags" },
            { id: 142, name: "Vanilla Essence", category: "General Food", unit: "ctn" },
            { id: 143, name: "Vanilla Powder", category: "General Food", unit: "ctn" },
            { id: 144, name: "Vegetables Oil", category: "General Food", unit: "tin" },
            { id: 145, name: "Whipping Cream", category: "Dairy", unit: "ctn" },
            { id: 146, name: "Compound White Chocolate", category: "General Food", unit: "ctn" },
            { id: 147, name: "White Garbage Bag", category: "Hygiene", unit: "ctn" },
            { id: 148, name: "White Improver", category: "General Food", unit: "bags" },
            { id: 149, name: "White Pepper Powder 24x250grm", category: "General Food", unit: "ctn" },
            { id: 150, name: "White Slice Cheese", category: "Dairy", unit: "ctn" },
            { id: 151, name: "White Vinegar", category: "General Food", unit: "ctn" },
            { id: 152, name: "Whole Meal Flour", category: "General Food", unit: "bags" },
            { id: 153, name: "Yeast", category: "General Food", unit: "ctn" },
            { id: 154, name: "Yellow Color", category: "General Food", unit: "ctn" },
            { id: 155, name: "Yogurt", category: "Dairy", unit: "ctn" },
            { id: 156, name: "Zatter", category: "General Food", unit: "bags" }
        ];

        const coverPageContainer = document.getElementById('cover-page-container');
        const userNameInput = document.getElementById('user-name-input');
        const proceedButton = document.getElementById('proceed-button');
        const mainFormContainer = document.getElementById('main-form-container');
        const lpoDashboardContainer = document.getElementById('lpo-dashboard-container'); // New LPO dashboard container
        const searchBar = document.getElementById('search-bar'); // New search bar element

        const itemsListDiv = document.getElementById('items-list');
        const orderSummaryDiv = document.getElementById('order-summary-div');
        const summaryList = document.getElementById('summary-list');
        const noItemsSelectedMsg = document.getElementById('no-items-selected-msg');
        const submitButton = document.getElementById('submit-button');
        const clearButton = document.getElementById('clear-button');
        const tabButtons = document.querySelectorAll('.tab-button');
        const pendingOrdersListDiv = document.getElementById('pending-orders-list'); // New element for pending orders
        const noPendingOrdersMsg = document.getElementById('no-pending-orders'); // New element

        let currentActiveCategory = 'All'; // Track active category for filtering
        let currentSearchQuery = ''; // Track search query

        // Event listener for tab buttons
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                // Remove 'active' class from all buttons
                tabButtons.forEach(btn => btn.classList.remove('active'));
                // Add 'active' class to the clicked button
                button.classList.add('active');
                currentActiveCategory = button.dataset.category;

                // Hide/show containers based on active tab
                if (currentActiveCategory === 'LPO Dashboard') {
                    mainFormContainer.classList.add('hidden');
                    lpoDashboardContainer.classList.remove('hidden');
                    loadPendingOrders(); // Load orders when LPO Dashboard is active
                } else {
                    mainFormContainer.classList.remove('hidden');
                    lpoDashboardContainer.classList.add('hidden');
                    searchBar.value = ''; // Clear search bar when category changes
                    currentSearchQuery = ''; // Reset search query
                    renderItems(); // Re-render items for the main form
                }
            });
        });

        // Event listener for search bar
        searchBar.addEventListener('input', (event) => {
            currentSearchQuery = event.target.value.toLowerCase();
            renderItems(); // Re-render items based on the search query
        });

        clearButton.addEventListener('click', clearForm);
        submitButton.addEventListener('click', handleSubmitOrder);

        /**
         * Renders material items based on the active category and search query.
         */
        function renderItems() {
            itemsListDiv.innerHTML = ''; // Clear current items

            const filteredItems = items.filter(item => {
                const matchesCategory = currentActiveCategory === 'All' || item.category === currentActiveCategory;
                const matchesSearch = item.name.toLowerCase().includes(currentSearchQuery);
                return matchesCategory && matchesSearch;
            });

            filteredItems.forEach(item => {
                const itemCard = document.createElement('div');
                itemCard.className = 'item-card bg-white p-4 rounded-lg shadow-md flex items-center justify-between';
                itemCard.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <label for="item-${item.id}" class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" id="item-${item.id}" data-item-id="${item.id}" class="item-checkbox form-checkbox h-5 w-5 text-indigo-600">
                            <span class="text-gray-800 text-lg font-medium">${item.name}</span>
                        </label>
                    </div>
                    <div class="flex items-center space-x-2">
                        <input type="number" id="quantity-${item.id}" value="0" min="0" class="w-20 px-2 py-1 border rounded-md text-center bg-gray-100 quantity-input" disabled>
                        <span class="text-gray-600 text-sm">${item.unit}</span> <!-- Display unit here -->
                    </div>
                `;
                itemsListDiv.appendChild(itemCard);

                const checkbox = itemCard.querySelector(`#item-${item.id}`);
                const quantityInput = itemCard.querySelector(`#quantity-${item.id}`);

                checkbox.addEventListener('change', () => {
                    quantityInput.disabled = !checkbox.checked;
                    if (checkbox.checked) {
                        quantityInput.value = 1; // Default to 1 when checked
                        quantityInput.classList.remove('bg-gray-100');
                        quantityInput.classList.add('bg-white');
                    } else {
                        quantityInput.value = 0; // Reset to 0 when unchecked
                        quantityInput.classList.remove('bg-white');
                        quantityInput.classList.add('bg-gray-100');
                    }
                    updateOrderSummary();
                });

                quantityInput.addEventListener('input', updateOrderSummary);
            });
        }

        /**
         * Gathers selected items and their quantities for the order summary and submission.
         * @returns {Array} An array of objects, each representing an ordered item.
         */
        function getSelectedOrderItems() {
            const order = [];
            const checkboxes = document.querySelectorAll('.item-checkbox:checked');

            checkboxes.forEach(checkbox => {
                const itemId = parseInt(checkbox.dataset.itemId);
                const quantityInput = document.getElementById(`quantity-${itemId}`);
                const quantity = parseInt(quantityInput.value);

                if (quantity > 0) {
                    const item = items.find(i => i.id === itemId);
                    order.push({
                        id: item.id,
                        name: item.name,
                        quantity: quantity,
                        unit: item.unit // Unit is now directly available from the items array
                    });
                }
            });
            return order;
        }

        /**
         * Updates the visible order summary based on current selections.
         */
        function updateOrderSummary() {
            const order = getSelectedOrderItems();
            summaryList.innerHTML = ''; // Clear previous summary

            if (order.length === 0) {
                noItemsSelectedMsg.classList.remove('hidden');
                summaryList.classList.add('hidden');
                orderSummaryDiv.classList.add('hidden'); // Hide the whole summary div
            } else {
                noItemsSelectedMsg.classList.add('hidden');
                summaryList.classList.remove('hidden');
                orderSummaryDiv.classList.remove('hidden'); // Show the whole summary div
                order.forEach(item => {
                    const listItem = document.createElement('li');
                    // Display item with unit in summary
                    listItem.textContent = `${item.name}: ${item.quantity} ${item.unit}`;
                    summaryList.appendChild(listItem);
                });
            }
        }

        /**
         * Handles the submission of the order to the Google Apps Script.
         */
        async function handleSubmitOrder() {
            const order = getSelectedOrderItems();
            const submittedBy = sessionStorage.getItem('userName') || 'Anonymous'; // Get name from session storage

            if (order.length === 0) {
                alert('Please select at least one item and enter a quantity greater than zero.');
                return;
            }

            const payload = {
                orders: order,
                submittedBy: submittedBy
            };

            submitButton.disabled = true; // Disable button to prevent double submission
            submitButton.textContent = 'Submitting...';

            try {
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Required for cross-origin requests to Apps Script
                    cache: 'no-cache',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                alert('Order submitted successfully! The sheet should be updated shortly.');
                clearForm(); // Clear the form after successful submission
            } catch (error) {
                console.error('Error submitting order:', error);
                alert('There was an error submitting your order. Please try again or contact support.');
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Submit Order';
                updateOrderSummary(); // Update summary in case items were cleared
            }
        }

        /**
         * Clears all selected checkboxes and resets quantities.
         */
        function clearForm() {
            const checkboxes = document.querySelectorAll('.item-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
                const quantityInput = document.getElementById(`quantity-${checkbox.dataset.itemId}`);
                quantityInput.value = 0;
                quantityInput.disabled = true;
                quantityInput.classList.remove('bg-white');
                quantityInput.classList.add('bg-gray-100');
            });
            orderSummaryDiv.classList.add('hidden'); // Hide summary after clearing
            searchBar.value = ''; // Clear search bar
            currentSearchQuery = ''; // Reset search query
            updateOrderSummary(); // Ensure summary is updated after clearing
            renderItems(); // Re-render items to show all after clearing search
        }

        /**
         * Fetches and displays pending orders in the LPO Dashboard.
         */
        async function loadPendingOrders() {
            pendingOrdersListDiv.innerHTML = '<p class="text-center text-gray-500">Loading pending orders...</p>';
            noPendingOrdersMsg.classList.add('hidden');

            try {
                const response = await fetch(`${WEB_APP_URL}?action=getPendingOrders`, {
                    method: 'GET', // Using GET for fetching data
                    mode: 'no-cors',
                    cache: 'no-cache'
                });

                // Due to no-cors, we can't directly read the response.
                // We'll trust the Apps Script to return valid JSON, and handle it
                // by assuming success and then needing a way to get the data.
                // For 'no-cors', the actual data needs to be returned via a different mechanism
                // or we need to switch to a 'cors' setup if possible (which Apps Script doesn't natively support for JSON output).

                // For now, we'll make a direct call to the Apps Script function for simplicity in testing.
                // In a real 'no-cors' scenario, you'd typically redirect or use a different endpoint.
                // For this demonstration, we'll simulate the data fetching.

                // A more robust solution for fetching data with no-cors would involve the Apps Script
                // returning HTML Service content or a redirect, or using a proxy.
                // For now, let's assume the Apps Script 'getPendingOrders' function will be called directly
                // in a way that provides data, or we'll adjust the fetch to a different method if needed.

                // For the purpose of demonstration, we'll simulate data.
                // In a real scenario, the Apps Script getPendingOrders would return data directly.
                const mockResponse = {
                    success: true,
                    data: [
                        { "Date": "07/15/2025", "Time": "10:30:00", "Item Name": "Pizza box 9x9", "Quantity": 5, "Unit": "ctn", "Submitted By": "John Doe", "LPO ID": "" },
                        { "Date": "07/15/2025", "Time": "10:45:00", "Item Name": "Beef Burger", "Quantity": 10, "Unit": "ctn", "Submitted By": "Jane Smith", "LPO ID": "" },
                        { "Date": "07/15/2025", "Time": "11:00:00", "Item Name": "Aluminum Foil", "Quantity": 2, "Unit": "ctn", "Submitted By": "John Doe", "LPO ID": "" }
                    ]
                };


                if (mockResponse.success && mockResponse.data.length > 0) {
                    pendingOrdersListDiv.innerHTML = ''; // Clear loading message
                    mockResponse.data.forEach(order => {
                        const orderCard = document.createElement('div');
                        orderCard.className = 'order-card';
                        orderCard.innerHTML = `
                            <p class="font-semibold text-lg">${order['Item Name']} - Qty: ${order.Quantity} ${order.Unit}</p>
                            <p class="text-gray-600 text-sm">Ordered by: ${order['Submitted By']} on ${order.Date} at ${order.Time}</p>
                            <button class="mt-3 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded">Generate LPO</button>
                        `;
                        pendingOrdersListDiv.appendChild(orderCard);
                    });
                } else {
                    noPendingOrdersMsg.classList.remove('hidden');
                    pendingOrdersListDiv.innerHTML = ''; // Clear loading message
                }

            } catch (error) {
                console.error('Error loading pending orders:', error);
                pendingOrdersListDiv.innerHTML = '<p class="text-center text-red-500">Failed to load orders. Please try again.</p>';
            }
        }


        // Cover page logic
        proceedButton.addEventListener('click', () => {
            const userName = userNameInput.value.trim();
            if (userName) {
                sessionStorage.setItem('userName', userName);
                coverPageContainer.classList.add('hidden');
                mainFormContainer.classList.remove('hidden');
                renderItems(); // Render items after showing the main form
            } else {
                alert('Please enter your name to proceed.');
            }
        });

        // Initial load check
        window.onload = () => {
            if (sessionStorage.getItem('userName')) {
                mainFormContainer.classList.remove('hidden');
                coverPageContainer.classList.add('hidden');
                renderItems(); // Render items if already logged in
            } else {
                coverPageContainer.classList.remove('hidden');
                mainFormContainer.classList.add('hidden');
            }
        };
    </script>
</body>
</html>
